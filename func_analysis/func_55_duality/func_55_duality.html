<h1>Çifteşlik, İkizlik (Duality)</h1>
<!DOCTYPE html>
<html>
  <head>
    <title>Çifteşlik, İkizlik (Duality)
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
<script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
</script>
</head>

<p>Bu benim en favori konularımdan. Çok faydalı ve çok güzel bir teknik, bakış
açısı. Bu konu üzerinde iki ders zamanı harcayacağız. Konuyu lineer
programlama (LP) üzerinden göreceğiz, çünkü bu alanda çifteşlik pratik
olarak rahatça gösterilebiliyor.</p>
<p>[önceki ders özeti atlandı]</p>
<p>Önümüzdeki iki ders için teori şapkamızı takacağız, tabii çifteşliğin pek
çok optimizasyon problemi üzerinde çok ciddi etkileri var. Yani bu konu
bulutlar üzerinde, aşırı soyut bir konu değil, onu vurgulamak istiyorum. </p>
<p>Ama şimdilik soyut denebilecek bir problemle başlayalım. Diyelim ki elimde
bir LP var ve bu LP'nin optimal değeri için bir alt sınır bulmak istiyorum,
$B \le \min_x f(x)$. Çifteşliğe bu çok basit soru üzerinden giriş
yapacağız. Örnek</p>
<p>$$
\min_{x,y} x+y, \quad \textrm{öyle ki}
$$
$$
x + y \ge 2 
$$
$$
x,y \ge 0
$$</p>
<p>dogru olsun. </p>
<p>İki skalar değişken var, ve pozitif olmalılar. Bu problem için alt sınır
nedir? Çıplak gözle bile bakarak bunu bulabiliriz, cevap 2. Değil mi? $x+y
\ge 2$ şartına uymak gerekiyorsa alt sınır 2 olacaktır. </p>
<p>Bazılarınız düşünebilir ki "şanslıydık, problem şartları aradığımız şeyi
söylüyordu zaten". Doğru fakat iddia ediyorum ki bu stratejiyi metodik bir
şekilde de kullanabilirdik. Benzer bir problem, </p>
<p>$$
\min_{x,y} x + 3y, \quad \textrm{öyle ki}
$$
$$
x + y \ge 2 
$$
$$
x \ge 0, y \ge 0
$$</p>
<p>Bu problemin alt sınırını nasıl buluruz?</p>
<p>Eğer $y \ge 0$ şartını ikiyle çarparsak $2y \ge 0$ diye yeni bir şart elde
ederiz (hala doğru), bu yeni şartı alıp $x + y \ge 2 $'a eklersek $x + 3y
\ge 2 $ şeklinde bir şart daha elde etmiş oluruz. Bu şart hedef
fonksiyonuna benzediği için alt sınırı direk söylüyor, alt sınır yine 2.</p>
<p>Üstteki probleme daha genel bir açıdan bakalım,</p>
<p>$$
\min_{x,y} px + qy, \quad \textrm{öyle ki}
$$
$$
x + y \ge 2
$$
$$
x,y \ge 0
$$</p>
<p>Alt sınır nedir? Öncekine göre biraz farklı bir strateji izleyeceğiz,
diyelim ki her şartı $a,b,c$ sabitleri ile çarptım, </p>
<p>$$
ax + ay \ge 2a
$$
$$
bx \ge 0
$$
$$
cy \ge 0
$$</p>
<p>Bu tabii ki $a,b,c \ge 0$ ise yapılabilir yoksa işaretler değişirdi. Devam
edelim, yine bazı ek koşullar yaratmış oldum. Bu yeni şartları toplarsam
bir yeni şart daha elde ederim,</p>
<p>$$
(a+b)x + (a+c)y \ge 2a
$$</p>
<p>Yeni değişken isimleri $p,q$ atarsam</p>
<p>$$
px + qy \ge 2a
$$</p>
<p>atama</p>
<p>$$
a+b = p, \quad a+c = q
$$</p>
<p>Aslında alt sınırı iki üstteki denklemden bulmuş olduk, $2a$ (bir üstteki
şartlara uyulduğu sürece tabii).</p>
<p>Eğer en iyi alt sınırı isteseydim, onu nasıl elde ederdim? Bu demektir ki
$2a$ olabildiğince büyük olmalı, tabii belli şartlara uyulduğu
sürece. Aslında bu soru bizi ikinci bir LP'ye götürüyor, literatürde ana
LP'nin çifteşi / ikizi denen LP'ye. İki değişkenli ortamda,</p>
<p>$$
\max_{a,b,c} 2a \quad \textrm{öyle ki}
$$
$$
a + b = p
$$
$$
a + c = q
$$
$$
a,b,c \ge 0
$$</p>
<p>Maksimum arandığına dikkat ve bu problemde üç tane değişken var (ana
problemde iki taneydi). Ve böylece deriz ki üstteki şartlara uyan her
$a,b,c$ (ki bu şartlara ikizin olurluk / fizibilite şartları deniyor)
maksimal noktada ana problemin alt sınırını minimize eder.</p>
<p>Bir soru sorayım: acaba üstteki problemden bir eşitlik elde etmem mümkün
mü? Yani ikizdeki problemin optimal değeri ana problemdeki optimal değere
eşit olabilir mi? Cevap evet. Peki arada boşluk olması mümkün mü? Cevap
(bazen) evet. İyi bir sezgisel bakış bu, ana ve ikiz LP optimal değerleri
neredeyse her zaman birbirine eşittir, bazı istanai patolojik durumlar
dışında.</p>
<p>Farklı bir probleme bakalım. Bu problemde bir eşitlik te olacak. </p>
<p>$$
\min_{a,b,c} px + qy \quad \textrm{öyle ki}
$$
$$
x \ge 0
$$
$$
y \le 1
$$
$$
3x + y = 2
$$</p>
<p>İkizi bulmak için her koşul için bir değişken atayalım, ama ondan önce her
ana koşulda eşitsizlikler aynı şekilde ise işimiz daha rahatlaşır (çünkü
$a,b,c,..$ değişkenlerini sıfırdan büyük yapacağız, ama farklı yönleri
gösteren ana koşullar ile bu zorlaşıyor), $y \le 1$ yerine $-y \ge -1$
mesela, o zaman</p>
<p>$$
\min_{a,b,c} px + qy \quad \textrm{öyle ki}
$$
$$
x \ge 0
$$
$$
-y \ge -1
$$
$$
3x + y = 2
$$</p>
<p>Yine $a,b,c$ ile çarpıyorum, </p>
<p>$$
a x \ge 0
$$
$$
-by \ge -b
$$
$$
3cx + cy = 2c
$$
$$
a,b \ge 0
$$</p>
<p>$c$ üzerinde koşul var mı? Hayır, çünkü $c$'nin çarptığı koşul bir eşitlik,
$c$ ne olursa olsun yeni koşul geçerli, işaret değişiminden korkmaya gerek
yok.</p>
<p>Önceden olduğu gibi bir toplam alıyoruz, </p>
<p>$$
(a+3c) x + (-b+c)y \ge -b + 2c
$$</p>
<p>Yine $p,q$ atamasını yaparsam,</p>
<p>$$
p x + q y \ge -b + 2c
$$</p>
<p>$$
p = a+3c, \quad q = -b + c 
$$</p>
<p>İkiz problemi elde ettik, amaç ana problemin alt sınırı $-b+2c$'yi maksimize
etmek, üstteki iki şart ve $a,b \ge 0$ olacak şekilde. </p>
<p>$$
\max_{a,b,c} 2c - b \quad \textrm{öyle ki}
$$
$$
a + 3c = p
$$
$$
-b + c = q
$$
$$
a,b \ge 0
$$</p>
<p>Dersin geri kalanında ikizlikten genel bir çerçevede bahsedeceğim, sonra 
bir ilginç örnek göreceğiz, ardından ikizliğe yeni bir bakış açısından
yaklaşacağız, bu acı çok önemli olacak. Dersi ikinci bir örnekle
bitireceğiz. </p>
<p>LP'lere tüm genelliği ile bakalım şimdi. Önceki format neler olup bittiğini
görmek açısından faydalı, ama genel şablonu da görmek lazım. </p>
<p>Tanımlar</p>
<p>$c \in \mathbb{R}^n$, 
$A \in \mathbb{R}^{m \times n}$, 
$b \in \mathbb{R}^m$,
$G \in \mathbb{R}^{r \times n}$, 
$h \in \mathbb{R}^r$ verili. </p>
<p>Ana Problem</p>
<p>$$
\min_x c^T x \quad \textrm{öyle ki}
$$
$$
Ax = b
$$
$$
Gx \le h
$$</p>
<p>İkiz Problem</p>
<p>$$
\max_{u,v} -b^T u - h^T v \quad \textrm{öyle ki}
$$
$$
-A^Tu - G^Tv = c
$$
$$
v \ge 0
$$</p>
<p>İkizi nasıl elde ettik? </p>
<p>$Ax = b$ ve $Gx \le h$ için iki (vektör) değişkeni tanımlıyoruz, sırasıyla
$u,v$. $u$ için kısıtlama yok, çünkü eşitlik için. Sadece $v \ge 0$
olmalı. </p>
<p>Eger $x$ olurlu ise </p>
<p>$$
a^T (Ax - b) + v^T (Gx-h) \le 0
$$</p>
<p>olur çünkü olurluluk noktasında $Ax - b=0$ ve $Gx-h \le 0$, bu sebeple
üstteki toplam tabii ki sıfırdan küçük.</p>
<p>Gruplarsak,</p>
<p>$$
(A^T u + G^T v)^T x - b^Tu - h^T v \ge 0
$$</p>
<p>$$
(-A^T u - G^T v)^T x \ge  -b^Tu - h^T v 
$$</p>
<p>Parantez içini $c$'ye atarsam o zaman </p>
<p>$$
c^T x \ge  -b^Tu - h^T v 
$$</p>
<p>Böylece eşitliğin sağ tarafı alt sınırım olur, sol tarafı ise ikiz
değişkenlerim üzerinde kısıtlama haline gelir, $v \ge 0$. Böylece ikiz
probleme erişmiş oluyoruz.</p>
<p>Sonraki ornege gelelim. Bu probleme maks akis min kesis (max flow min cut)
problemi deniyor. Konunun gelismesindeki ilginc bir hikaye 20. yuzyil
basinda Sovyetler maks akis Amerikalilar ise min kesis problemlerini
cozmeye odaklanmisti, fakat bu iki problem ikizlik uzerinden aslinda ayni
problem.</p>
<p>Maksimum akış problemi şöyle: bir yönlü çizit verildi diyelim,</p>
<p><img alt="" src="func_55_duality_01.png" /></p>
<p>İki nokta arasında bağlantı varsa $c_{ij}$ o iki nokta $i,j$ arasındaki
bağlantının kapasitesini gösteriyor, eğer bir tren hattından bahsediyorsak
o bağlantıdan geçebilecek yük miktarı, eğer şu borusu ise oradan akabilecek
su miktarı, ya da bir yol ise o yolun uzunluğu, vs. olabilir. Bir
bağlantıdan gerçekte olan akışı $f_{ij}$ olarak tanımlayabiliriz,</p>
<p>$$
0 \le f_{ij} \le c_{ij}
$$</p>
<p>ve $i,j \in E$ olacak, burada $E$ tüm kenarların (edges) indisleri, çizit
$G = (V,E)$ olarak tanımlı, $V$ çizitin düğüm noktaları (vertices). Bir
diğer şart (ki aslında bu bariz) bir düğüme giren akışın çıkan akışla eşit
olması. </p>
<p>$$
\sum_{(i,k) \in E} f_{ik} = \sum_{kj} f_{kj} \quad k \in V \backslash {s,t} 
$$</p>
<p>Not: $\backslash$ işareti "hariç" demek. </p>
<p>Maks akış problemi eldeki bir mali, nakliyatı diyelim, bir başlangıç
noktası $s$ bitişi noktası $t$'ye maksimum miktarda nakil edebilecek yolları
bulmaktır. Dikkat: $s$'den mal göndermek deyince $s$'den çıkan pek çok
yoldan nakliyat paylaştırılarak gönderilebilir, altta görüldüğü gibi
(kırmızı hat kapasitesi, yeşil bir optimal akış örneği, başlangıç 0 bitiş
7).</p>
<p><img alt="" src="func_55_duality_02.png" /></p>
<p>O zaman maksimum akışı bir LP olarak kodlayalım,</p>
<p>$$
\max_{f \in \mathbb{R}^{|E|}} \sum_{(s,j)\in E} f_{sj}, \quad \textrm{öyle ki}
$$
$$
0 \le f_{ij} \le c_{ij}, \quad \forall i,j \in E
$$
$$
\sum_{(i,k) \in E} f_{ik} = \sum_{kj} f_{kj} \quad k \in V \backslash {s,t} 
$$</p>
<p>Fakat tek bir toplam ile tüm çizit üzerinden maksimum akışı nasıl formülize
edebildik? Hedef fonksiyonundaki toplam sadece başlangıç $s$'den çıkan
akışa bakıyor? Buradaki ufak numara yaptığımız kısıtlamayla bağlantılı,
akisin muhafaza edilmesini şart koştuğumuz için optimal akış, her ne ise,
çıkış noktasından olan toplamı ile varış noktasına girişi aynı tutmalı
(aradaki geçiş düğümleri için de aynı şey geçerli olduğu için tabii), bu
sebeple optimizasyonu tek bir toplam ile tanımlayabildik. Üstteki grafik
örnekte görülüyor, çıkış toplam 3+2+1 varış toplam 4+2. O zaman çıkışı
optimize edersek $t$'ye varan, tüm düğümler üzerinden olabilecek akışı
maksimize etmiş oluruz.</p>
<p>Bu programın ikizini hesaplayabiliriz, üstteki bir LP ikizini bulmayi
biliyoruz, ana LP'dekiler kısıtlamalar kadar yeni değişken elde ederiz,
vs.. Daha önce minimizasyon problemlerinin ikizine baktık, ana problemde
bir alt sınır elde etmeye uğraşıyorduk. Şimdi ana problem maksimizasyon, o
zaman hedef için üst sınır aramak bizi ikize götürür. Min probleminde bile
hedefe bir eksi işareti eklesem onu maksimizasyon olarak görebilirdim, ve
üst sınıra bakabilirdim. İkizin türetisi için notlara bakabilirsiniz
[2]. Sonuçta şu minimizasyonu elde ediyorum,</p>
<p>$$
\min_{b \in \mathbb{R}^{|E|}, x \in \mathbb{R}^{|V|}} 
\sum _{(i,j) \in E} b_{ij} c_{ij} \quad \textrm{öyle ki}
$$</p>
<p>$$
b_{ij} \ge x_i - x_j
$$
$$
b_{ij}, x_i,x_j \in { 0,1} \quad \forall i,j
$$</p>
<p>Elde ettiğimiz sonuc (hala ikize gelmedik) şunu söylüyor, elimdeki
düğümleri öyle iki gruba ayırmak istiyorum ki (altta bir grup görülüyor,
renkli kısım), bir gruptan diğer gruba geçen kapasitelerin, geçen
kenarların kapasitelerinin toplamı minimal olsun.</p>
<p><img alt="" src="func_55_duality_03.png" /></p>
<p>Bu arada üstteki program bir LP değil, bir tamsayı programı (ınteğer
program) çünkü eldeki düğümleri bir gruba ya da diğerine (0,1 değerleri
üzerinden) atıyoruz, değişkenler ikisel, doğal olarak tam sayılar. Şimdi
ikize geliyoruz, ana problemi ikiz üstteki tamsayı programının gevşetilmiş
(relaxation) hali. 0,1 tamsayılarını alıp onları 0 ile 1 arasında gidip
gelebilen reel değişkenler olarak tanımlarsak bir LP elde ederiz. </p>
<p>Yani ana / ikizlik ve üstteki gevşetme arasındaki ilişkiler şöyle</p>
<p>maksimum akış değeri $\le$ 
gevşetilmiş minimum kesiş $\le$ 
minimum kesişin kapasitesi</p>
<p>Gevşetme ile minimum değer daha azaldı, tamsayı programını gevşetip
dışbükey program haline getirince bunun olduğu biliniyor, kısıtlama
kümesini genişlettim, bu minimumu küçültecektir. </p>
<p>Herhalde keşiş kelimesinin nereden geldiği anlaşılıyor şimdi, eğer elimde
bir makasla renkli bölgeye giden bağlantıları kessem, en az mıktarda akışı
kesmiş olurum, ve o renkli bölge içindeki akış en yüksek kapasitede olur.
Ve buradaki problemde güçlü ikizlik durumu olduğu için bu iki değer
birbirine eşit! </p>
<p>Şimdi LP ikizliğine farklı bir açıdan bakalım, ki bu açı oldukca faydalı
olacak. </p>
<p>Örnek</p>
<p><img alt="" src="func_55_duality_04.png" />
<img alt="" src="func_55_duality_05.png" /></p>
<pre><code class="python">from scipy.optimize import linprog
import numpy as np

A_ub = np.eye(5)
b_ub = np.array([1.,2.,2.,3.,1.])
A_eq = np.array([[1, 0, -1, -1, 0],
                 [0, 1, 1, 0, -1]])
b_eq = np.array([ 0, 0 ]);
f = np.array( [ 1, 1, 0, 0, 0 ])
res = linprog(-f, A_ub=A_ub, b_ub=b_ub, \
                 A_eq=A_eq, b_eq=b_eq)
print (np.round(res.x))
</code></pre>

<pre><code>[1. 1. 0. 1. 1.]
</code></pre>

<pre><code class="python">print (res.x.dot(f))
</code></pre>

<pre><code>1.9999999998438802
</code></pre>

<p>Not: <code>linprog</code> minimize etmeye ayarlı olduğu için hedefi eksi ile
çarptık, yani maksimizasyon yaptırmış olduk.</p>
<p>Maksimum akış 2.0 olarak bulundu. Optimize edilen $-c^T x$ dersek vektör
$x$ içindeki öğeler $e_1,e_2,e_3,e_4,e_5$, ve $c$ içinde $1,1,0,0,0$ var,
yani aslında sadece $e_1,e_2$'nin akış toplamına bakmış oluyoruz. Bu normal,
sebeplerinden önce bahsetmiştik. Bulunan sonuç $x^* = (1,1,0,1,1)$, onu
$c^Tx^*$ çarpımı ilk iki öğeyi toplatıyor, ve 1+1 = 2. </p>
<p>Eşitlik kısıtlamaları $A_{eq}$ ve $b_{eq}$ içinde, sadece iki kısıtlama
var, bu kısıtlamalardan ilki 1'e giren $e_1$ ile ondan çıkan $e_3,e_4$'un
eşit olması gerektiğini söylüyor, bu sebeple ilk kısıtlama $1,0,-1,-1,0$,
ve ona tekabül eden $b_{eq}$ sıfır değerinde, $e_1$ akışı ile $e_3,e_4$
toplanırsa sıfır olsun demiş oluyoruz. İkinci kısıtlama 2'ye giren iki akış
$e_2,e_3$ ile çıkan $e_5$'i dengeliyor.</p>
<p>[devam edecek]</p>
<p>Kaynaklar</p>
<p>[1] Tibshirani, <em>Convex Optimization, Lecture Video 10</em>, 
<a href="https://www.youtube.com/channel/UCIvaLZcfz3ikJ1cD-zMpIXg">https://www.youtube.com/channel/UCIvaLZcfz3ikJ1cD-zMpIXg</a>   </p>
<p>[1] Tibshirani, <em>Convex Optimization, Lecture Notes</em>, 
<a href="https://www.stat.cmu.edu/~ryantibs/convexopt/">https://www.stat.cmu.edu/~ryantibs/convexopt/</a></p>